generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Role: OWNER = full access, AGENCY = access to own clients, CLIENT = own account only
model User {
  id                Int                @id @default(autoincrement())
  email             String             @unique
  password          String
  name              String?
  role              String             @default("CLIENT") // OWNER, AGENCY, CLIENT
  vapiCredits       Float              @default(0) // VAPI call credits balance
  outboundRate      Float              @default(0.10) // $ per minute for outbound calls
  inboundRate       Float              @default(0.05) // $ per minute for inbound calls
  companyName       String?            // Custom branding: company name
  companyLogo       String?            // Custom branding: logo URL
  companyTagline    String?            // Custom branding: tagline
  vapiApiKey        String?            // Encrypted - Per-account VAPI API Key
  vapiPublicKey     String?            // Encrypted - Per-account VAPI Public Key
  triggerApiKey     String?            // Encrypted - API key for /api/call/trigger
  agencyId          Int?               // If CLIENT, belongs to this agency
  agency            User?              @relation("AgencyClients", fields: [agencyId], references: [id])
  clients           User[]             @relation("AgencyClients") // If AGENCY, these are their clients
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  agents            Agent[]
  twilioCredentials TwilioCredentials?
  teamMembers       TeamMember[]       @relation("AccountTeamMembers")
  ghlIntegration    GHLIntegration?
  calendarIntegrations CalendarIntegration[]
  supportTickets       SupportTicket[]
  ticketReplies        TicketReply[]
  vapiKeyPoolEntry     VapiKeyPool?
  complianceSetting    ComplianceSetting?
}

model VapiKeyPool {
  id              Int      @id @default(autoincrement())
  label           String?  // Optional friendly name (e.g. "VAPI Org #1")
  vapiApiKey      String   // Encrypted private key
  vapiPublicKey   String   // Encrypted public key
  assignedUserId  Int?     @unique // null = available, set = assigned
  assignedUser    User?    @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model GHLIntegration {
  id              Int       @id @default(autoincrement())
  privateToken    String?   // Encrypted Private Integration Token (legacy)
  accessToken     String?   // Encrypted OAuth access token
  refreshToken    String?   // Encrypted OAuth refresh token
  tokenExpiresAt  DateTime? // OAuth token expiry timestamp
  companyId       String?   // From OAuth response
  locationId      String?   // GHL Location ID
  locationName    String?   // Friendly name of the location
  isConnected     Boolean   @default(false)
  userId          Int       @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model CalendarIntegration {
  id                Int       @id @default(autoincrement())
  provider          String    // "google", "ghl", "calendly", "hubspot", "calcom"
  accessToken       String?   // Encrypted OAuth token
  refreshToken      String?   // Encrypted refresh token
  apiKey            String?   // Encrypted API key (Cal.com)
  tokenExpiresAt    DateTime?
  externalAccountId String?   // Provider account ID (Google email, GHL locationId)
  accountLabel      String?   // e.g. "john@gmail.com", "GHL - My Location"
  isConnected       Boolean   @default(false)
  metadata          String?   // JSON for provider-specific data
  userId            Int
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  @@unique([userId, provider, externalAccountId])
}

model TeamMember {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String
  name        String?
  teamRole    String   @default("user") // "admin" or "user"
  accountId   Int      // The parent account this team member belongs to
  account     User     @relation("AccountTeamMembers", fields: [accountId], references: [id], onDelete: Cascade)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Agent {
  id           Int           @id @default(autoincrement())
  name         String
  description  String?
  agentType    String        @default("outbound")
  vapiId       String?
  config       String?
  userId       Int
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  phoneNumbers PhoneNumber[]
}

model TwilioCredentials {
  id           Int           @id @default(autoincrement())
  accountSid   String        // Encrypted
  authToken    String        // Encrypted
  userId       Int           @unique
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneNumbers PhoneNumber[]
  isVerified   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model PlatformSettings {
  id                 Int      @id @default(autoincrement())
  vapiApiKey         String?  // Encrypted
  vapiPublicKey      String?  // Encrypted - VAPI Public Key for web SDK
  openaiApiKey       String?  // Encrypted
  elevenLabsApiKey   String?  // Encrypted - ElevenLabs API Key for voice library
  slackWebhookUrl    String?  // Encrypted - Slack incoming webhook URL
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model CallRate {
  id              Int      @id @default(autoincrement())
  outboundRate    Float    @default(0.10) // $ per minute for outbound calls
  inboundRate     Float    @default(0.05) // $ per minute for inbound calls
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model CallLog {
  id              Int      @id @default(autoincrement())
  vapiCallId      String   @unique // VAPI call ID
  userId          Int      // User who made/received the call
  type            String   // "outbound" or "inbound"
  durationSeconds Float    @default(0)
  costCharged     Float    @default(0) // Amount deducted from credits
  billed          Boolean  @default(false)
  outcome         String   @default("unknown") // answered, booked, not_interested, failed, transferred, voicemail, unknown
  agentId         Int?     // Local agent ID for per-agent filtering
  recordingUrl    String?  // Our local recording URL
  transcript      String?  // Full transcript text
  summary         String?  // Call summary
  structuredData  String?  // JSON string of extracted data
  endedReason     String?  // Why the call ended
  customerNumber  String?  // The customer's phone number
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PhoneNumber {
  id                  Int               @id @default(autoincrement())
  phoneNumber         String            // E.164 format
  friendlyName        String?
  twilioSid           String            // Twilio phone number SID
  vapiPhoneNumberId   String?           // After VAPI import
  status              String            @default("pending") // pending, active, error
  twilioCredentialsId Int
  twilioCredentials   TwilioCredentials @relation(fields: [twilioCredentialsId], references: [id], onDelete: Cascade)
  agentId             Int?
  agent               Agent?            @relation(fields: [agentId], references: [id], onDelete: SetNull)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Same Twilio number can exist for different credentials (different users)
  @@unique([twilioSid, twilioCredentialsId])
}

model CustomVoice {
  id          Int      @id @default(autoincrement())
  voiceId     String   // ElevenLabs voice_id
  name        String
  gender      String?  // male, female
  accent      String?  // american, british, etc.
  languages   String?  // JSON array e.g. '["en","es"]'
  description String?
  previewUrl  String?
  provider    String   @default("11labs")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([voiceId, provider])
}

model SupportTicket {
  id          Int            @id @default(autoincrement())
  title       String
  description String
  status      String         @default("open")
  priority    String         @default("medium")
  category    String         @default("general")
  userId      Int
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies     TicketReply[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model TicketReply {
  id        Int           @id @default(autoincrement())
  message   String
  isStaff   Boolean       @default(false)
  userId    Int
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketId  Int
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now())
}

model AuditLog {
  id           Int      @id @default(autoincrement())
  userId       Int      // Account this action belongs to
  actorId      Int?     // Who performed the action (user or team member ID)
  actorEmail   String?  // Email of the actor
  actorType    String?  // "user", "team_member", "system"
  action       String   // e.g. "login", "agent.create", "settings.update"
  resourceType String?  // e.g. "agent", "team_member", "compliance_setting"
  resourceId   String?  // ID of the affected resource
  details      String?  // JSON string with extra context
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
}

model ComplianceSetting {
  id                Int       @id @default(autoincrement())
  hipaaEnabled      Boolean   @default(false)
  baaSignedDate     DateTime?
  baaCounterparty   String?   // Name of the BAA counterparty
  baaDocumentUrl    String?   // URL or reference to BAA document
  complianceOfficer String?   // Name of compliance officer
  dataRetentionDays Int       @default(365) // Data retention period
  lastReviewDate    DateTime?
  nextReviewDate    DateTime?
  notes             String?   // Additional compliance notes
  userId            Int       @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model ModelRate {
  id        Int      @id @default(autoincrement())
  provider  String   // "openai", "anthropic", "google", "groq", "deepseek", "mistral"
  model     String   // "gpt-4o", "claude-3-5-sonnet-20241022", etc.
  rate      Float    // $ per minute
  setById   Int      @default(0) // 0 = global (OWNER), >0 = agency user ID override
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([provider, model, setById])
}

model TranscriberRate {
  id        Int      @id @default(autoincrement())
  provider  String   // "deepgram", "assembly-ai", etc.
  rate      Float    // $ per minute
  setById   Int      @default(0) // 0 = global (OWNER), >0 = agency user ID override
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([provider, setById])
}
